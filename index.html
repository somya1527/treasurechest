<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Treasure — White Ground + Resized Player (Per-chest Questions) — Fixed + Sakura &amp; Fireworks + Ending Cinematic</title>
<style>
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:#061420;color:#eaf2ff}
  #app{display:flex;height:100vh}
  #left{flex:1; position:relative; overflow:hidden}
  canvas{display:block; width:100%; height:100%}
  #side{width:360px; padding:12px; background:linear-gradient(180deg,#071827,#052631); box-sizing:border-box}
  .pill{background:rgba(255,255,255,0.03); padding:8px 10px;border-radius:8px; display:inline-block; margin-right:6px}
  .small{font-size:13px;color:#98b9cf}
  .panel{background:rgba(255,255,255,0.02); padding:10px; border-radius:10px; margin-bottom:12px}
  button{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:inherit;cursor:pointer}
  .inv{display:flex; gap:6px; flex-wrap:wrap}
  .inv-item{background:rgba(255,255,255,0.02); padding:6px 8px; border-radius:6px; font-weight:800}
  textarea{font-family:inherit; font-size:13px; color:#eaf2ff; background:transparent; border:1px solid rgba(255,255,255,0.03); width:100%; box-sizing:border-box}
  .chest-area{display:grid; grid-template-columns:1fr; gap:8px; max-height:360px; overflow:auto; padding-right:6px}
  .chest-card{background:rgba(255,255,255,0.02); padding:8px; border-radius:8px}
  .chest-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .qa-row{display:flex; gap:6px}
  .qa-row input{flex:1; padding:6px; border-radius:6px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:inherit}
  .small-muted{font-size:12px;color:#7ea6c9}
  .admin-badge{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.04);font-weight:800}

  /* Popup modal styles */
  .birthday-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.75);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10000;
  }
  .birthday-box{
    width:clamp(320px, 80vw, 980px);
    max-height:90vh;
    overflow:auto;
    background:linear-gradient(180deg,#082a30,#06343a);
    border-radius:14px;
    padding:22px;
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
    color:#fff;
    text-align:center;
  }
  .birthday-text{
    font-weight:900;
    font-size:20px;
    line-height:1.15;
    white-space:pre-wrap;
    margin-bottom:18px;
    color:#ffd27a;
  }
  .birthday-sub{
    font-size:14px;
    color:#e8f9ff;
    margin-bottom:16px;
  }
  .birthday-close{
    display:inline-block;
    padding:10px 18px;
    border-radius:10px;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.06);
    cursor:pointer;
    font-weight:800;
  }

  /* simple floating hearts overlay (DOM) */
  .heart {
    position:fixed; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.95; font-size:18px;
    text-shadow:0 6px 18px rgba(0,0,0,0.4);
  }

  /* chest number popup (DOM) */
  .chest-popup{
    position:fixed;
    pointer-events:none;
    z-index:99999;
    transform:translate(-50%,-120%);
    background:rgba(255,255,255,0.95);
    color:#06111a;
    font-weight:900;
    padding:8px 12px;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,0.45);
    min-width:44px;
    text-align:center;
    font-size:18px;
    display:none;
  }
  .chest-popup .num{font-size:22px;}

  /* Treasure-map styled letter popup */
  .letter-overlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.78);
    z-index:9999;
  }
  .letter-box{
    position:relative;
    width:clamp(480px, 70vw, 900px);
    min-height: min(520px, 80vh);
    max-height: 90vh;
    padding:28px 30px 22px 30px;
    box-sizing:border-box;
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,0.85);
    overflow:hidden;
    color:#2b2014;
    background:
      radial-gradient(circle at 10% 0%, rgba(0,0,0,0.16) 0, transparent 45%),
      radial-gradient(circle at 90% 100%, rgba(0,0,0,0.26) 0, transparent 45%),
      linear-gradient(135deg,#f5e2b8 0,#f0d6a0 40%,#e7c88c 70%,#f4ddb1 100%);
    border:3px solid rgba(92,61,23,0.85);
    transform:scale(0.94);
    animation: letterPopIn 200ms ease-out forwards;
  }
  .letter-box::before{
    content:"";
    position:absolute;
    inset:12px;
    border-radius:14px;
    border:1px dashed rgba(112,76,32,0.5);
    pointer-events:none;
  }
  .letter-box::after{
    content:"X";
    position:absolute;
    right:32px;
    bottom:26px;
    font-family:"Georgia",serif;
    font-weight:900;
    color:rgba(125,43,32,0.8);
    font-size:26px;
    transform:rotate(-10deg);
    opacity:0.8;
  }
  .letter-title{
    font-family:"Georgia","Times New Roman",serif;
    font-size:24px;
    font-weight:900;
    letter-spacing:0.06em;
    text-transform:uppercase;
    color:#4a2c14;
    margin-bottom:6px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .letter-title span.chest-chip{
    font-size:12px;
    padding:4px 8px;
    border-radius:999px;
    background:rgba(92,61,23,0.12);
    border:1px solid rgba(92,61,23,0.25);
    text-transform:none;
    letter-spacing:0;
  }
  .letter-sub{
    font-size:13px;
    color:#705135;
    margin-bottom:14px;
    font-style:italic;
  }
  .letter-scroll{
    position:relative;
    margin-top:6px;
    padding:14px 16px 12px 16px;
    border-radius:12px;
    background:radial-gradient(circle at 0 0,rgba(255,255,255,0.65) 0,transparent 50%) #f6e7c0;
    box-shadow:inset 0 0 0 1px rgba(160,122,64,0.18);
    max-height:52vh;
    overflow:auto;
  }
  .letter-scroll::before,
  .letter-scroll::after{
    content:"";
    position:absolute;
    left:10px;
    right:10px;
    height:2px;
    border-top:1px dashed rgba(132,97,53,0.5);
  }
  .letter-scroll::before{ top:12px; }
  .letter-scroll::after{ bottom:10px; }
  .letter-textarea{
    width:100%;
    border:none;
    background:transparent;
    resize:vertical;
    outline:none;
    padding:10px 4px 4px 4px;
    box-sizing:border-box;
    font-family:"Georgia","Times New Roman",serif;
    font-size:15px;
    line-height:1.5;
    color:#3b2713;
    min-height:220px;
    max-height:50vh;
  }
  .letter-textarea::placeholder{
    color:rgba(112,81,53,0.6);
  }
  .letter-actions{
    margin-top:14px;
    display:flex;
    justify-content:flex-end;
    gap:8px;
  }
  .letter-actions button{
    font-weight:800;
    font-size:13px;
    padding:8px 16px;
    border-radius:999px;
    border:1px solid rgba(92,61,23,0.55);
    background:linear-gradient(135deg,rgba(255,247,220,0.98),rgba(240,215,172,0.98));
    color:#3b2713;
    box-shadow:0 3px 8px rgba(0,0,0,0.28);
  }
  .letter-actions button:nth-child(2){
    background:rgba(0,0,0,0.04);
    border-color:rgba(92,61,23,0.4);
    box-shadow:none;
  }
  .letter-admin-note{
    margin-top:4px;
    font-size:11px;
    color:#876242;
    text-align:right;
  }
  @keyframes letterPopIn{
    from{ transform:scale(0.92); opacity:0; }
    to{ transform:scale(1); opacity:1; }
  }

  /* small floating HUD button for non-admin reset */
  #resetProgressUser {
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.06);
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:800;
  }

  /* ending cinematic styles */
  #endingOverlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(rgba(0,0,0,0.0), rgba(0,0,0,0.62));
    z-index:20000;
    pointer-events:none;
    opacity:0;
    transition:opacity 600ms ease;
  }
  #endingOverlay.show{ opacity:1; pointer-events:auto; }
  .ending-message{
    font-family: "Georgia", serif;
    background:rgba(255,255,255,0.98);
    color:#2b2014;
    padding:26px 34px;
    border-radius:14px;
    border:3px solid rgba(92,61,23,0.85);
    font-size:28px;
    font-weight:900;
    text-align:center;
    max-width:88vw;
    box-shadow:0 20px 60px rgba(0,0,0,0.6);
  }
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
    "three/": "https://unpkg.com/three@0.152.2/"
  }
}
</script>
</head>
<body>
  <!-- Birthday popup (shows immediately on load) -->
  <div id="birthdayPopup" class="birthday-overlay" aria-hidden="false" role="dialog">
    <div class="birthday-box" role="document">
      <div class="birthday-text" id="birthdayText">
HAAAAAAAAAAPPPPPPPPPYYYYYYYYYYYYYY BBBBBBBBIIIIIIIRRRRRRRRRTTTTTTTTTTHHHHHHHHHDDDDDDDAAAAAAAYYYYYY DOOOOOOOBBBIIIIIIIIIII!!!!!! 
Now, there are 20 chests in this small game I made, you cannot open any chest at random, all of them are numbered, BUTT(yours) THEY ARE PASSWORD PROTECTED, if the question has options jaise A or B, just write the letter A or B as the answer, not the entire sentence ok? Use ARROW KEYS to move(aur iss para ke beech koi number aara ho toh just move idhr udhr ok? surri) (To open any chest, press Tab) I LAVE YYOOUUU!! ( p.s. its not alot pr just know I made it with love.)
      </div>
      <div class="birthday-sub">(Click below to close — message shown on load)</div>
      <button id="birthdayClose" class="birthday-close">Close</button>
    </div>
  </div>


      <div style="position:absolute; right:12px; top:12px; z-index:60; display:flex; align-items:center; gap:8px">
        <span class="pill">Found: <span id="found">0</span>/20</span>
        <span class="pill" id="nextPill">Next: <span id="next">1</span></span>

        <!-- new: user reset button (visible to everyone) -->
        <button id="resetProgressUser" title="Reset your local progress">Reset progress</button>
      </div>

      <div id="tooltip"></div>
      <canvas id="glcanvas"></canvas>
    </div>

    <aside id="side">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Player & Letters</strong><div class="small">20 chests — each chest has its own textarea and a Q & A. Changes are saved with the Save button (or auto-saved when you open a chest).</div></div>
          <div><span id="adminBadge" class="admin-badge" style="display:none">ADMIN</span><button id="copyHTML">Copy HTML</button></div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Letters for chests — each chest has its own textarea and a Q & A. Use the Save button to persist (admin only).</div>
          <div class="chest-area" id="chestArea"></div>
        </div>

        <div style="display:flex; gap:8px; margin-top:8px">
          <button id="saveBtn">Save</button>
          <button id="resetBtn">Reset progress</button>
          <button id="regenBtn">Regenerate world</button>
        </div>

        <div id="readOnlyNote" class="small" style="margin-top:8px; display:none">You are in read-only mode. Add <code>?admin=dobbi</code> to the URL to enable editing.</div>
      </div>

      <div class="panel">
        <strong>Cinematic / Dialog</strong>
        <div class="small">Dialog box shows opened letters and typewriter-style dialog. (TTS option removed)</div>
        <div style="margin-top:10px">
          <div id="dialogBox"></div>
        </div>
      </div>

      <div class="panel small">
        Right-drag rotates camera yaw; W moves toward camera-facing forward. World is now smaller for easier play.
      </div>
    </aside>
  </div>

  <!-- chest number popup (DOM) -->
  <div id="chestPopup" class="chest-popup"><span class="num">1</span></div>

  <!-- ending cinematic overlay (hidden until triggered) -->
  <div id="endingOverlay" aria-hidden="true">
    <div class="ending-message">Thank you for being in my life.</div>
  </div>

  <script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
  import { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';

  // simple logger
  function slog(msg){ console.log(msg); }
  window.addEventListener('error', e => { slog('Error: ' + (e.message || e)); });
  window.addEventListener('unhandledrejection', e => { slog('Rejection: ' + (e.reason || e)); });

  // Admin check — enable admin editing only when URL has ?admin=dobbi
  const params = new URLSearchParams(window.location.search);
  const isAdmin = params.get('admin') === 'dobbi';

  // DOM refs
  const canvas = document.getElementById('glcanvas');
  const tooltipEl = document.getElementById('tooltip');
  const foundEl = document.getElementById('found');
  const nextEl = document.getElementById('next');
  const nextPill = document.getElementById('nextPill');
  const chestArea = document.getElementById('chestArea');
  const saveBtn = document.getElementById('saveBtn');
  const resetBtn = document.getElementById('resetBtn');
  const regenBtn = document.getElementById('regenBtn');
  const dialogBox = document.getElementById('dialogBox');
  const copyHTML = document.getElementById('copyHTML');
  const chestPopup = document.getElementById('chestPopup');
  const adminBadge = document.getElementById('adminBadge');
  const readOnlyNote = document.getElementById('readOnlyNote');
  const resetUserBtn = document.getElementById('resetProgressUser');
  const endingOverlay = document.getElementById('endingOverlay');

  // renderer & scene
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false, preserveDrawingBuffer: false });
  renderer.shadowMap.enabled = true;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xbfdfff); // soft sky

  const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 5000);
  camera.position.set(0, 320, 700);

  // --- Color / tone improvements (makes colors punchier) ---
  renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping; // filmic color response
  renderer.toneMappingExposure = 1.35;                // raise for more punch (1.0 - 1.6 typical)
  renderer.physicallyCorrectLights = true;

  // smoothed camera follow helpers
  const cameraTarget = new THREE.Vector3();
  const desiredCamPos = new THREE.Vector3();
  const tmpVec3 = new THREE.Vector3();
  const camWorldOffset = new THREE.Vector3();
  const CAMERA_POS_LERP = 0.18;
  const CAMERA_TARGET_LERP = 0.25;

  // camera yaw controls
  let cameraYaw = Math.PI * 0.25;
  let cameraPitch = -0.35;
  let isDragging = false;
  let lastPointerX = 0, lastPointerY = 0;
  const canvasEl = renderer.domElement;
  canvasEl.addEventListener('contextmenu', e => e.preventDefault());
  canvasEl.addEventListener('pointerdown', (e) => {
    if(e.button === 2){ isDragging = true; lastPointerX = e.clientX; lastPointerY = e.clientY; canvasEl.setPointerCapture(e.pointerId); }
  });
  canvasEl.addEventListener('pointerup', (e) => { if(e.button === 2){ isDragging = false; try{ canvasEl.releasePointerCapture(e.pointerId); }catch(_){} }});
  canvasEl.addEventListener('pointermove', (e) => {
    if(!isDragging) return;
    const dx = e.clientX - lastPointerX; const dy = e.clientY - lastPointerY;
    lastPointerX = e.clientX; lastPointerY = e.clientY;
    cameraYaw -= dx * 0.005;
    cameraPitch = Math.max(-0.6, Math.min(0.6, cameraPitch - dy * 0.003));
  });
  // wheel zoom
  let cameraDistanceDefault = 420;
  canvasEl.addEventListener('wheel', (e) => { cameraDistanceDefault = Math.max(60, Math.min(900, cameraDistanceDefault + e.deltaY * 0.1)); e.preventDefault(); }, { passive:false });

  // lights (warmer/brighter to avoid dull look)
  const hemi = new THREE.HemisphereLight(0xfff7e6 /*sky warm*/, 0x7fb3c9 /*ground cool*/, 1.4);
  scene.add(hemi);

  const dir = new THREE.DirectionalLight(0xffffff, 1.6);
  dir.position.set(200,400,100);
  dir.castShadow = true;
  dir.shadow.radius = 2;
  dir.shadow.bias = -0.0005;
  scene.add(dir);

  // soft ambient to keep shadows from going dead black
  const amb = new THREE.AmbientLight(0xffffff, 0.12);
  scene.add(amb);

  // ground (natural grass green)
  const WORLD_W = 2000, WORLD_H = 1600;
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(WORLD_W, WORLD_H, 8,8),
    new THREE.MeshStandardMaterial({ color:0x27ae60, roughness:0.85, metalness:0.02 })
  );
  ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

  // player & placeholder (resized)
  const player = new THREE.Group(); player.position.set(0,40,0); player.scale.set(5,5,5); scene.add(player);
  cameraTarget.copy(player.position).add(new THREE.Vector3(0, 20, 0));
  let placeholder = null;
  (function makePlaceholder(){
    placeholder = new THREE.Group();
    const torso = new THREE.Mesh(new THREE.BoxGeometry(18,28,12), new THREE.MeshStandardMaterial({ color:0xec4899 }));
    torso.position.y = 28; placeholder.add(torso);
    const head = new THREE.Mesh(new THREE.SphereGeometry(9,12,8), new THREE.MeshStandardMaterial({ color:0xffdcc3 }));
    head.position.y = 48; placeholder.add(head);
    const hair = new THREE.Mesh(new THREE.BoxGeometry(20,18,18), new THREE.MeshStandardMaterial({ color:0x2b1b0f }));
    hair.position.set(0,44,-6); placeholder.add(hair);
    player.add(placeholder);
  })();

  // SAKURA TREES - trunk brown, leaves pink
  const sakuraGroup = new THREE.Group(); scene.add(sakuraGroup);
  function makeSakuraTree(){
    const g = new THREE.Group();
    // trunk — brown (natural)
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(2,3,28,8), new THREE.MeshStandardMaterial({ color:0x8b5a2b }));
    trunk.position.y = 14; g.add(trunk);

    const canopy = new THREE.Group();
    for(let i=0;i<18;i++){
      // leaves/flowers — pink
      const s = new THREE.Mesh(new THREE.SphereGeometry(6.5,6,6), new THREE.MeshStandardMaterial({ color: 0xff73a0, flatShading:true }));
      const ang = Math.random()*Math.PI*2; const r = 6 + Math.random()*18; const y = 8 + Math.random()*22;
      s.position.set(Math.cos(ang)*r, y, Math.sin(ang)*r);
      s.scale.setScalar(0.7 + Math.random()*1.2);
      canopy.add(s);
    }
    canopy.position.y = 28; g.add(canopy);
    return g;
  }

  function placeSakuraTrees(count=40){
    while(sakuraGroup.children.length) sakuraGroup.remove(sakuraGroup.children[0]);
    const margin = 220;
    for(let i=0;i<count;i++){
      let x = (Math.random()-0.5)*(WORLD_W - margin*2);
      let z = (Math.random()-0.5)*(WORLD_H - margin*2);
      if(Math.hypot(x,z) < 220){ x += Math.sign(x||1)*220; z += Math.sign(z||1)*220; }
      const t = makeSakuraTree();
      t.position.set(x,0,z);
      t.scale.setScalar(1.0 + Math.random()*0.9);
      sakuraGroup.add(t);
    }
    // ensure all trunks/leaves locked to intended colors (post-adjust)
    sakuraGroup.traverse(n => {
      if(n.isMesh && n.material){
        if(n.geometry && n.geometry.type === 'CylinderGeometry'){
          // trunk(s)
          n.material.color.setHex(0x8b5a2b);
          n.material.needsUpdate = true;
        } else {
          // canopy pieces (pink)
          n.material.color.setHex(0xff73a0);
          n.material.emissive = new THREE.Color(0x330018);
          n.material.emissiveIntensity = 0.06;
          n.material.needsUpdate = true;
        }
      }
    });
  }
  placeSakuraTrees(48);

  // chests (open-world placement, no barriers)
  let chests = [];

  // label creation accounts for DPR for crisp text
  function makeLabelPlane(txt){
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
    const baseSize = 256;
    const c = document.createElement('canvas');
    c.width = baseSize * DPR; c.height = baseSize * DPR;
    const ctx = c.getContext('2d');
    ctx.scale(DPR, DPR);
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,baseSize, baseSize);
    ctx.fillStyle='#06111a';
    ctx.font='bold 120px sans-serif';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(txt, (baseSize / 2), (baseSize / 2));
    const tex = new THREE.CanvasTexture(c);
    tex.generateMipmaps = false;
    tex.minFilter = THREE.LinearFilter;
    tex.magFilter = THREE.LinearFilter;
    return new THREE.Mesh(new THREE.PlaneGeometry(16,16), new THREE.MeshBasicMaterial({ map:tex, transparent:true }));
  }

  function placeWorld(){
    chests.forEach(c=>scene.remove(c.group)); chests=[];
    const margin = 200;
    for(let i=1;i<=20;i++){
      let placed=false, tries=0;
      while(!placed && tries<5000){
        const x = (Math.random()-0.5)*(WORLD_W - margin*2);
        const z = (Math.random()-0.5)*(WORLD_H - margin*2);
        if(Math.hypot(x,z) < 200){ tries++; continue; }
        let ok=true; for(const c of chests) if(Math.hypot(c.x-x,c.z-z) < 180){ ok=false; break; }
        if(!ok){ tries++; continue; }
        const g = new THREE.Group();
        const baseMat = new THREE.MeshStandardMaterial({ color:0x6b3b2a, roughness:0.9, metalness:0.02 });
        const lidMat = new THREE.MeshStandardMaterial({ color:0xf59e0b, roughness:0.35, metalness:0.45 }); // shinier gold-like lid
        const base = new THREE.Mesh(new THREE.BoxGeometry(18,12,14), baseMat); base.position.y=6; g.add(base);
        const lid = new THREE.Mesh(new THREE.BoxGeometry(20,8,16), lidMat); lid.position.y=14; g.add(lid);
        const lab = makeLabelPlane(String(i)); lab.position.set(0,8,8.9); g.add(lab);
        g.position.set(x,0,z); scene.add(g);
        chests.push({ id:i, group:g, lid, label:lab, opened:false, collected:false, x, z, question:'What is 2 + 2?', answer:'4' });
        placed=true;
      }
    }
  }
  placeWorld();

  // particles
  let particlePool = []; let particles = [];
  function ensureParticleMeshes(n){ while(particlePool.length < n){ const s = new THREE.Mesh(new THREE.SphereGeometry(2,6,6), new THREE.MeshStandardMaterial({ color:0xffd27a })); s.castShadow=false; s.receiveShadow=false; scene.add(s); particlePool.push(s); } }
  function spawnParticlesAt(x, z, count=12){ for(let i=0;i<count;i++){ const angle = Math.random()*Math.PI*2; particles.push({ pos:new THREE.Vector3(x,24+Math.random()*20,z), vel:new THREE.Vector3(Math.cos(angle)*(30+Math.random()*80),40+Math.random()*120,Math.sin(angle)*(30+Math.random()*80)), life:0.8+Math.random()*0.8, color: Math.random()>0.5?0xffd27a:0xff9f76 }); } }

  // LOVELY HEART PARTICLES (ambient)
  let heartPool = []; let heartParticles = [];
  function ensureHeartMeshes(n){ while(heartPool.length < n){ const geom = new THREE.SphereGeometry(2.2,6,6); const mat = new THREE.MeshStandardMaterial({ color:0xff6fbf, transparent:true, opacity:0.95 }); const m = new THREE.Mesh(geom, mat); m.castShadow=false; m.receiveShadow=false; scene.add(m); heartPool.push(m); } }
  function spawnHeart(x,y,z, velY=20){ heartParticles.push({ pos:new THREE.Vector3(x,y,z), vel:new THREE.Vector3((Math.random()-0.5)*8, velY+(Math.random()*20), (Math.random()-0.5)*8), life:2 + Math.random()*3, scale:0.8+Math.random()*1.2 }); }
  setInterval(()=>{ if(Math.random()<0.6) spawnHeart(player.position.x + (Math.random()-0.5)*60, player.position.y + 30 + Math.random()*30, player.position.z + (Math.random()-0.5)*60, 20); }, 800);

  // fireworks system
  let fireworksActive = false;
  let fireworkPool = [];
  function ensureFireworkMeshes(n){ while(fireworkPool.length < n){ const s = new THREE.Mesh(new THREE.SphereGeometry(1.8,6,6), new THREE.MeshStandardMaterial({ color:0xffffff, emissive:0xffffff })); s.castShadow=false; s.receiveShadow=false; scene.add(s); fireworkPool.push(s); } }
  function triggerFireworks(duration=4500){
    if(fireworksActive) return;
    fireworksActive = true;
    const started = performance.now();
    ensureFireworkMeshes(200);
    const interval = setInterval(()=>{
      const cx = player.position.x + (Math.random()-0.5)*60;
      const cz = player.position.z + (Math.random()-0.5)*60;
      const cy = player.position.y + 200 + Math.random()*120;
      const pieces = 30 + Math.floor(Math.random()*40);
      for(let i=0;i<pieces;i++){
        const ang = Math.random()*Math.PI*2; const elev = Math.random()*Math.PI*0.8; const speed = 80 + Math.random()*240;
        const vx = Math.cos(ang)*Math.sin(elev)*speed; const vz = Math.sin(ang)*Math.sin(elev)*speed; const vy = Math.cos(elev)*speed;
        particles.push({ pos:new THREE.Vector3(cx, cy, cz), vel:new THREE.Vector3(vx, vy, vz), life:1.1 + Math.random()*1.6, color: [0xff3d6b,0xffb36b,0xfff36b,0x6bafff][Math.floor(Math.random()*4)] });
      }
    }, 300);
    const heartBurst = setInterval(()=>{ for(let i=0;i<12;i++){ createDOMHeartBurst(); } }, 400);
    setTimeout(()=>{ clearInterval(interval); clearInterval(heartBurst); fireworksActive = false; }, duration);
  }

  function createDOMHeartBurst(){ const el = document.createElement('div'); el.className='heart'; el.textContent='❤'; document.body.appendChild(el); const x = window.innerWidth * (0.2 + Math.random()*0.6); const y = window.innerHeight * (0.5 + Math.random()*0.4);
    el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.fontSize = (12 + Math.random()*28) + 'px'; el.style.opacity = '0.95'; const dx = (Math.random()-0.5)*200; const dy = -200 - Math.random()*200; el.animate([{ transform:`translate(${0}px, ${0}px)`, opacity:1 },{ transform:`translate(${dx}px, ${dy}px) rotate(${Math.random()*180}deg)`, opacity:0 }], { duration: 1800 + Math.random()*1000, easing:'cubic-bezier(.2,.7,.2,1)' }); setTimeout(()=>el.remove(), 2200); }

  // persistence & UI
  let letters = [
    ` Elo dobi, bhai meri itni fattri if you'll like this or not pr ab anayway, I wanna tell you theengs. Before you came into my life, I thought I understood what love meant, mtlb with my family, people talk about like they’re standard, everyday emotions. But the truth is, I was operating on that version of love that I didn’t even realize was incomplete.

Then you walked in.

And it wasn’t fireworks or drama or some unrealistic movie thing. It was something quieter but far deeper, the kind of shift you only notice once you look back and see who you used to be compared to who you are now.

You made space for me without asking me to shrink. You made me feel seen without making me perform for attention. You made me feel understood without me having to over-explain myself.

And that is rare.
That is precious.
That is real.

You don’t know how many times I’ve gone through a rough moment and found myself calming down just because I remembered something you said, or the way you said it, or the way you looked at me last time I was going through something. You don’t know how many doubts you’ve pushed out of my head without even realizing you were doing it.

You’ve changed my life in ways I still haven’t fully processed. And I love you for that, not because you “fixed” me, but because you made me feel supported enough to fix myself.`,

    `You are the only person I can be fully myself with

I don’t pretend around you.
I don’t exaggerate.
I don’t hide the parts of myself that aren’t polished or perfect or impressive.

You’ve seen the best of me and the messiest parts of me. You’ve seen me confused, irritated, silent, tired, hopeful, sarcastic, insecure, everything. Somehow you handle all of it with this strange combination of patience and bluntness that I genuinely admire.

You don’t pamper my ego, and you don’t crush it either. You hold me accountable when you need to, and you back me up when I’m trying to do better. You don’t want the edited version of me. You want the real one.

That is the most freeing feeling in the world.

I love that with you I don’t have to constantly think about what I’m saying or whether I’m being impressive enough. I can breathe around you, fully, deeply.

You don’t realize how much strength you give me just by being someone I can drop my guard around..`,

    `You make me want to be better, not obly for myself, but also for us.

You’re not the kind of person who demands perfection. You never expect me to be some unrealistically flawless version of a boyfriend. But being with you makes me want to level up. Not because I feel pressured, but because I finally feel like the effort would mean something.

When I imagine a future, you’re in it.
You give that future weight and direction.
You make me want to work harder, think smarter, and grow up in all the ways that matter.

And honestly? That’s love.
Not grand gestures.
Not fancy lines.
Not drama.

To me, love is wanting to be a better person because the one you love deserves the best version of you..`,

    `You’re beautiful in the kind of way that shows up even on tired days, even when you’re annoyed, even when you’re frustrated, even when you’re half asleep or distracted.

It’s in the way your eyes look when you’re trying not to blush.
It’s in the way your voice shifts when you’re genuinely excited about something.
It’s in the subtle expressions you don’t realize you make when you’re thinking.
It’s in the way you carry yourself, this chota baccha personality around me.

And yes, I love the obvious things too, the things anyone would notice. But it’s the small things I’m obsessed with. The things only I get to see. The details you don’t pay attention to.

Those are the things that stay with me.`,
    `You’re strong in ways you don’t give yourself credit for

You act like you’re “normal” or “just doing what you have to,” but no, you’re stronger than you think. You’ve dealt with situations that would break other people. You’ve kept moving even when life was draining, confusing, or just straight up unfair.

You always underestimate how resilient you are.
You don’t brag about it.
You don’t even acknowledge it.

But I see it.
I notice it.
I admire it.

You handle things with a balance of strength and vulnerability that I honestly respect so much. And if you ever start to doubt your own strength, remember this: I’ve seen you at your lowest and I’ve seen you fight your way out of it. You’re stronger than most people your age, stronger than most people in general, and definitely stronger than you allow yourself to believe.`,
    `You love in a way that feels genuine and grounded

You don’t throw around “I love you” like it’s a quick text. You show it in actions — in the small things you think I don’t notice, but I do.

The way you check on me when you sense something’s off.
The way you remember small details I forgot I even told you.
The way you’re honest with me even when the truth isn’t comfortable.
The way you show up for me whenever I need you.

And it’s that kind of love that lasts.`,
    `You’re my safe place

Life is noisy. People are unpredictable. Days can feel heavy out of nowhere. But every time things feel overwhelming, you’re the first person my mind runs toward.

Not because I want escape, but because you feel like clarity. You feel like calm. You feel like home.

I don’t say that lightly.
“Home” isn’t a place.
It’s a person.

And for me, that person is you. Every single time.`,
    `You’ve given me a love that feels equal

There’s no imbalance with us, no one-sided effort, no forced roles, no silent expectations. We meet each other in the middle. We give, we take, we talk, we argue, we fix things.

We grow together.
And that matters more than anything.

Because real love isn’t about one person carrying the relationship, it’s about two people choosing each other again and again, even on tough days.

And I will choose you every time.`,
    `You deserve the kind of love that doesn’t fade, and I want to give you exactly that

You deserve steadiness.
You deserve loyalty.
You deserve a partner who shows up, not one who disappears when things get difficult.
You deserve love that doesn’t crumble under stress.

And I’m not saying I’m perfect or that I’ll never make mistakes. But I’m damn sure of one thing: I’m committed to you. To us. To everything we’re building.

I want the long-term with you.
The real thing.
The type of love that doesn’t burn out.`,
    `I love who you are now, and I love who you’re becoming

Turning 20 is a big deal, whether you realize it or not. You’re stepping into a new stage of life — one where you’ll learn more about yourself, discover new sides of your personality, face new challenges, and grow in ways you can’t predict yet.

And I want you to know something important:

I’m not just in love with who you are right now, I’m in love with the person you’re becoming too.

I love your potential.
I love your ambition.
I love the fire in you, even when it flickers.

I can’t wait to see the world you build for yourself over the next few years. And I want to be right beside you while you’re doing it.`,
    `I love you because being with you feels effortless

Some relationships feel like constant work, endless confusion, stress, doubts. But with you, things fall into place. Not because everything is perfect, but because we communicate, we understand each other, and we try.

That effortlessness isn’t luck.
It’s compatibility.
And it’s rare.

You’re the person I never get tired of talking to, the person I never get bored of being around, the person I can sit with in silence and still feel connected.

Being with you feels natural.
And that kind of emotional comfort is priceless.`,
    `Naked truth? I cant explain love in words. But I’ll try, because you deserve to hear it clearly:

I love you because you make my life lighter without ever making it smaller.
I love you because you bring meaning to moments that used to feel empty.
I love you because you understand me in a way no one else ever has.
I love you because you’ve become a part of the way I think, the way I hope, the way I plan my future.
I love you because you matter to me in a way nothing else compares to.

And I love you simply because you are you, and that alone is enough.`,
    `My promise to you, on your 20th birthday

I’m not promising a perfect relationship, that doesn’t exist.

But here’s what I can promise:

I’ll be honest with you even when it’s uncomfortable.

I’ll support you, not just say it.

I’ll listen, really listen, when something matters to you.

I’ll grow with you, not away from you.

I’ll love you in a way that’s stable, consistent, and transparent.

I’ll show up, even on the hard days.

I’ll respect you, your feelings, your dreams, your boundaries, your individuality.

And most importantly:
I’m here for the long run.
Not as a phase.
Not as a convenience.
But as your partner.`,
    `You pick up on my moods before I even put them into words. I could say I’m fine, and you’ll know instantly whether I actually am or whether I’m just trying to hold myself together. You can tell when something has been on my mind for hours even if I’ve been acting normal. You spot the way I get quieter when I’m overthinking, the way my responses get shorter when something’s bothering me, the way I fidget when I’m nervous, the way I start acting like everything is a “small thing” when actually it’s not.

And the craziest part is how naturally you respond. You don’t panic. You don’t force me to talk. You don’t make a scene. You just adjust, subtly, calmly, gently, in ways only someone who really loves you would know how to. Sometimes you shift the conversation. Sometimes you ask one simple question that unlocks everything I’ve been bottling up. Sometimes you just stay quiet and sit with me until I breathe normally again.

You read me in a way that’s rare. It’s like you understand the version of me that doesn’t speak, the version that lives behind my eyes, behind my routines, behind the emotions I don’t express out loud. You make me feel recognized in a way that scares me a little because it’s so unfamiliar, but also comforts me in a way I didn’t even know I needed.

Nobody else pays attention like that.`,
    `There’s a difference between being liked and being chosen.
Being liked is easy. Anyone can like you for a moment: a good conversation, a good mood, a pretty picture, a temporary burst of attention. People like each other all the time, casually, halfway, conditionally. Liking someone requires almost no courage. No commitment. No intention.

Choosing someone is completely different.
Choosing someone for something a they decide to do again and again, even on the days when it isn’t convenient or romantic or smooth.

And that’s what you do.
You don’t just like me, you choose me.

You choose me in the quiet ways and the loud ways. Not just when everything is perfect, but also when I’m tired, irritated, distracted, insecure, complicated, or just not at my best. You choose me on the normal days, not just the cute ones. You choose me when conversations get messy, when misunderstandings happen, when life gets heavy and nothing feels easy. You choose me even when I give you reasons to pull away, and instead of using my flaws as exits, you use them as places to understand me better.`,
    `You probably don’t realise this, but whenever my mind turns into a mess, when everything feels tangled, tense, noisy, or chaotic inside my head, you’re the only person who can cut through it without even trying. You don’t have to give long speeches or perfect advice. Just your presence, your tone, your questions, your way of looking at things… it all does something to me that I can’t explain in a simple sentence.

 I used to stay stuck in my own thoughts for hours. I would spiral, overanalyze, stress, worry, replay scenarios in loops until I exhausted myself. Most people made it worse. They either dismissed what I felt or overreacted to it, or they made the conversation about themselves. They added confusion instead of removing it. They made my brain louder.

You’re the opposite.

You simplify things.
You soften things.
You bring everything into focus.`,
    `It didn’t happen overnight. There wasn’t a single moment where I suddenly said, “Okay, from today onward, I’ll think about her all the time.” 
You slipped into my routine the way I slip and fell for you(ehe).

Now, you just exist in my head throughout the day, not as a distraction, not as some obsessive thing, but as something natural.

It’s not even always romantic. Sometimes it’s small things, like when I see something funny and the first thought isn’t “This is funny,” it’s “Dobi would like this.” Sometimes it’s when I’m tired, and my brain goes, “I wish I could talk to her right now.” Sometimes it’s when I’m planning my day and without even thinking, I leave space for you, space to talk to you, update you, hear your voice, or just be around you in some way.

You show up in my head the way important things do, naturally, without effort.

You’re there when I’m walking somewhere and something reminds me of a conversation we had.
You’re there when I listen to music, and certain lines suddenly carry your name in their meaning.
You’re there when I see a place and think, “I’d rather experience this with her.”
You’re there when something good happens, and my first instinct is to tell you.
You’re there when something bad happens, and I wish I could talk to you because you’re the one person who makes things feel lighter.`,
    `18 eh, legal age wa, KYA FAYDA, let this letter remind you that we haven't done it yet(thumbs up emoji).`,
    `Tum Se Hi Din Hota Hai
 Surmayi Shaam Aati Hai
 Tum Se Hi Tum Se Hi
 Har Ghadi Saans Aati Hai
 Zindagi Kehlati Hai
 Tum Se Hi Tum Se Hi

Haee, the movie we watched together eh? I love this song pta h, kyuki it reminds me of you. NEVER IN MY LIFE DID I THINK KI I'LL SIT AND WATCH A ROM COM, BOLLYWOOD AT THAT.`,
    `Ek baar chest close kr jldi phir wapas TAB dabakr khol dena!
Did it work? I hope it did, anyways, HAPPY BIRTHHDAAYYY DOOOBBBIIII I LAAVVVEEE YYOOUUU!.`
  ];
  let qa = [
  { question: "How old did Dobi turn today?", answer: "7" },
  { question: "Which insect (bigger than dobi) is dobi scared of?", answer: "grasshopper" },
  { question: "From 1-100, how beautiful is dobi?", answer: "100" },
  { question: "Can dobi reach or even see the top of a shelf? A) No B)Hell no", answer: "B" },
  { question: "From 1-69, how much does doba love his dobi?", answer: "69" },
  { question: "Write a nickname for dobi given by his beloved doba.(only one correct answer)", answer: "smurfette" },
  { question: "Can dobi's legs reach the ground when she sits on doba's cycle? A) Yes, assuming the ground elevates itself to her legs B) Yup, she grew taller", answer: "a" },
  { question: "What does doba wanna eat which is also the softest thing on earth? A) The most tasty food known to mankind B) Dobi's cheek", answer: "b" },
  { question: "What is that one chocolate that doba has given to dobi the most?", answer: "milkybar" },
  { question: "How many bouquets has doba given to dobi? (many more to come)", answer: "3" },
  { question: "Can doba ever stop loving dobi? A) IS THAT EVEN A QUESTION?!!", answer: "A" },
  { question: "Who is the prettiest girl in the UNIVERSE? A) Ofc its dobi B) Yeah there's no competition just pick A", answer: "A" },
  { question: "Where did doba and dobi plan to work if they moved out together?", answer: "Reliance" },
  { question: "From 1-100, how much attention does doba need from dobi?", answer: "100" },
  { question: "How many times did doba's laptop crash while preparing this game? A) 69 B) Uncountable with multiple crash outs", answer: "b" },
  { question: "Can doba ever get tired of dobi or even think about such stupid stuff? A) NEVER EVEN CROSSED HIS MIND", answer: "a" },
  { question: "Is doba scared of dobi? A) Uh, NO?! She's literally half his size B) Yeah she's read too many murder mystery novels", answer: "b" },
  { question: "On what date did doba propose to dobi?", answer: "12" },
  { question: "By whose presence itself does doba instantly lights up and forgets all his problems?", answer: "dobi" },
  { question: "CONGRATS, YOU'VE REACHED THE FINAL PIECE OF THE PUZZLE! But this is going to be the toughest question of them all! What does doba love the most about dobi?", answer: "everything" }
];

  let foundCount = 0;
  let nextChest = 1;
  const STORAGE_KEY = 'treasure_camfixed_small_perchest_q_v1_sakura';

  function createChestTextareas(){
    chestArea.innerHTML = '';
    for(let i=0;i<20;i++){
      const card = document.createElement('div'); card.className='chest-card';
      const header = document.createElement('div'); header.className='chest-header';
      const title = document.createElement('div'); title.textContent = `Chest ${i+1}`;
      const buttons = document.createElement('div');
      const openBtn = document.createElement('button'); openBtn.textContent='Teleport & Open'; openBtn.title='Teleport to chest and attempt to open it';
      openBtn.onclick = ()=>{ const c = chests.find(cc=>cc.id===i+1); if(c){ player.position.set(c.x, c.group.position.y + 40, c.z); interact(); } }
      const saveBtnLocal = document.createElement('button'); saveBtnLocal.textContent='Save'; saveBtnLocal.onclick = ()=>{ if(!isAdmin){ toast('Admin only'); return; } letters[i] = ta.value; qa[i].question = qIn.value; qa[i].answer = aIn.value; saveState(); refreshUI(); toast(`Saved chest ${i+1}`); };
      buttons.appendChild(openBtn);
      if(isAdmin) buttons.appendChild(saveBtnLocal);
      header.appendChild(title); header.appendChild(buttons);

      const ta = document.createElement('textarea'); ta.rows=4; ta.placeholder = `Letter for chest ${i+1} — paste long text here.`;
      const qLbl = document.createElement('div'); qLbl.className='small-muted'; qLbl.textContent = 'Question (shown before opening)';
      const qIn = document.createElement('input'); qIn.type='text'; qIn.placeholder='Question text';
      const aLbl = document.createElement('div'); aLbl.className='small-muted'; aLbl.textContent = 'Answer (case-insensitive)';
      const aIn = document.createElement('input'); aIn.type='text'; aIn.placeholder='Answer text';

      const qaRow = document.createElement('div'); qaRow.className='qa-row';
      qaRow.appendChild(qIn); qaRow.appendChild(aIn);

      card.appendChild(header);
      card.appendChild(ta);
      card.appendChild(qLbl);
      card.appendChild(qaRow);
      card.appendChild(aLbl);

      chestArea.appendChild(card);

      // populate from letters & qa arrays
      ta.value = letters[i] || '';
      qIn.value = qa[i] ? qa[i].question : '';
      aIn.value = qa[i] ? qa[i].answer : '';
      ta.dataset.index = String(i);
      qIn.dataset.index = String(i);
      aIn.dataset.index = String(i);

      // if not admin, make inputs read-only and hide local save
      if(!isAdmin){ ta.readOnly = true; qIn.readOnly = true; aIn.readOnly = true; }
    }
  }

  function saveState(){ if(!isAdmin){ slog('Attempted save prevented — not admin'); return; } try{ const st={ letters, qa, chests: chests.map(c=>({id:c.id, collected:c.collected})), foundCount, nextChest, player:{x:player.position.x, y:player.position.y, z:player.position.z} }; localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }catch(e){ console.warn(e); } }
  function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return false; const s = JSON.parse(raw); if(s.letters && Array.isArray(s.letters) && s.letters.length===20) letters=s.letters; if(s.qa && Array.isArray(s.qa) && s.qa.length===20) qa=s.qa; if(s.chests && s.chests.length===20){ setTimeout(()=>{ for(const sc of s.chests){ const f = chests.find(c=>c.id===sc.id); if(f && sc.collected){ f.collected=true; f.group.children[1].rotation.x=-0.9; } } refreshUI(); }, 40); } foundCount = s.foundCount || 0; nextChest = s.nextChest || 1; if(s.player && typeof s.player.x==='number') player.position.set(s.player.x, s.player.y, s.player.z); return true; }catch(e){ return false; } }

  function refreshUI(){ foundEl.textContent = foundCount; nextEl.textContent = nextChest; const cards = chestArea.querySelectorAll('.chest-card'); cards.forEach((card, idx) => {
      const ta = card.querySelector('textarea');
      const qIn = card.querySelectorAll('input')[0];
      const aIn = card.querySelectorAll('input')[1];
      if(ta) ta.value = letters[idx] || '';
      if(qIn) qIn.value = qa[idx] ? qa[idx].question : '';
      if(aIn) aIn.value = qa[idx] ? qa[idx].answer : '';
    }); }

  // ---------- Ending cinematic state & helpers ----------
  let cinematicActive = false;
  let cinematicStart = 0;
  let cinematicDuration = 9000;   // ms
  let cinematicRotations = 1.2;   // how many rotations the camera makes
  const cinematicLockInput = true; // whether to block player movement during cinematic

  function playEndingCinematic(){
    if(cinematicActive) return;
    cinematicActive = true;
    cinematicStart = performance.now();
    // longer fireworks during orbit
    try{ triggerFireworks(cinematicDuration + 1200); }catch(e){ console.warn('fireworks failed', e); }
    // lock input by clearing keys (your movement respects cinematicActive in mainLoop)
    if(cinematicLockInput){
      for(const k in keys) keys[k] = false;
    }
    // hide overlay until the very end (we'll reveal it from showEndingMessage)
    if(endingOverlay) { endingOverlay.classList.remove('show'); endingOverlay.setAttribute('aria-hidden','true'); }
  }

  function showEndingMessage(){
    if(!endingOverlay) return;
    endingOverlay.setAttribute('aria-hidden','false');
    endingOverlay.classList.add('show');
    // allow click to dismiss and return control
    endingOverlay.onclick = () => {
      endingOverlay.classList.remove('show');
      endingOverlay.setAttribute('aria-hidden','true');
      endingOverlay.onclick = null;
    };
  }

  // top-level save button will copy textarea contents into letters[] and persist (admin-only)
  saveBtn.onclick = ()=>{ if(!isAdmin){ toast('Admin only'); return; } const cards = chestArea.querySelectorAll('.chest-card'); cards.forEach((card) => {
      const idx = Number(card.querySelector('textarea').dataset.index);
      letters[idx] = card.querySelector('textarea').value;
      qa[idx].question = card.querySelectorAll('input')[0].value;
      qa[idx].answer = card.querySelectorAll('input')[1].value;
    }); saveState(); refreshUI(); toast('Saved all letters & Q/A'); };

  resetBtn.onclick = ()=>{ if(!confirm('Reset progress?')) return; foundCount = 0; nextChest = 1; chests.forEach(c=>{ c.collected = false; c.opened = false; try{ if(c.group && c.group.children[1]) c.group.children[1].rotation.x = 0; }catch(_){} }); saveState(); refreshUI(); toast('Progress reset'); };
  // new: user-facing reset button (local reset) — available to all players
  function localResetProgress(){
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    foundCount = 0;
    nextChest = 1;
    chests.forEach(c=>{ c.collected = false; c.opened = false; try{ if(c.group && c.group.children[1]) c.group.children[1].rotation.x = 0; }catch(_){} });
    refreshUI();
  }
  resetUserBtn.onclick = ()=>{ if(!confirm('Reset your local progress? This will clear progress stored in your browser only.')) return; localResetProgress(); toast('Your progress has been reset'); };

  regenBtn.onclick = ()=>{ if(!confirm('Regenerate world?')) return; chests.forEach(c=>{ try{ scene.remove(c.group); }catch(_){} }); chests=[]; placeWorld(); foundCount = 0; nextChest = 1; if(!qa || qa.length !== 20) qa = Array.from({length:20}, (_,i)=>({ question: `What is ${i+2} + ${i+1}?`, answer: String((i+2)+(i+1)) })); createChestTextareas(); refreshUI(); saveState(); toast('World regenerated'); };
  copyHTML.onclick = async ()=>{ try{ await navigator.clipboard.writeText(document.documentElement.outerHTML); toast('HTML copied'); }catch(e){ toast('copy failed'); } };

  function toast(msg, ms=1200){ const el = document.createElement('div'); el.textContent = msg; Object.assign(el.style,{position:'fixed',right:'18px',bottom:'18px',background:'rgba(0,0,0,0.7)',padding:'8px 12px',borderRadius:'8px',color:'#fff',zIndex:9999}); document.body.appendChild(el); setTimeout(()=>el.remove(), ms); }

  // movement & camera variables
  let velocity = new THREE.Vector3(0,0,0);
  let onGround = true;
  const GRAV = -2200;
  const MOVE_SPEED = 260;
  let walkTimer = 0;
  const keys = {};

  // ---------- MODIFIED: only track arrow keys for movement ----------
  window.addEventListener('keydown', e=>{
    const key = String(e.key || '').toLowerCase();

    // Tab: open chest
    if(key === 'tab'){ e.preventDefault(); e.stopPropagation(); interact(); return; }

    // Space: jump
    if(key === ' ' || key === 'spacebar' || e.code === 'Space'){ tryJump(); keys['space'] = true; return; }

    // Shift+O: alternate interact shortcut
    if(key === 'o' && e.shiftKey){ interact(); return; }

    // Only track Arrow keys for movement (ignore WASD)
    if(key.startsWith('arrow')){ keys[key] = true; }
  });

  window.addEventListener('keyup', e=>{
    const key = String(e.key || '').toLowerCase();
    if(key.startsWith('arrow')){ keys[key] = false; }
    if(key === ' ' || key === 'spacebar' || e.code === 'Space'){ keys['space'] = false; }
  });

  function tryJump(){ if(onGround){ velocity.y = 700; onGround = false; } }

  // interaction
  function interact(){ let nearest=null, nd=Infinity; for(const c of chests){ const d=Math.hypot(player.position.x - c.x, player.position.z - c.z); if(d<nd && d<220){ nd=d; nearest=c; } } if(!nearest) return; if(nearest.collected){ const text = letters[nearest.id-1] || ''; showLetter(nearest.id, text); return; }
    if(nearest.id !== nextChest){ toast(`Chest ${nearest.id} locked. Need ${nextChest}`); return; }
    const qobj = qa[nearest.id-1] || { question: `Answer this to open chest ${nearest.id}`, answer: '' };
    askQuestion(nearest.id, qobj.question, qobj.answer, (ok) => {
      if(ok){
        nearest.collected=true; nearest.group.children[1].rotation.x=-0.9; foundCount++; nextChest = Math.min(20, nextChest+1); spawnParticlesAt(nearest.x, nearest.z, 24); const text = letters[nearest.id-1] || ''; showLetter(nearest.id, text); saveState(); refreshUI(); 
        if(foundCount === 20){
          // trigger cinematic now
          playEndingCinematic();
          toast('All chests collected — beautiful!');
        }
      } else {
        toast('Incorrect — try again');
      }
    });
  }

  // question modal helper
  function askQuestion(id, question, answer, cb){
    const overlay=document.createElement('div'); Object.assign(overlay.style,{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,0.55)',zIndex:9999});
    const box=document.createElement('div'); box.style.cssText='background:#082a30;color:#fff;padding:18px;border-radius:12px;min-width:320px;max-width:86vw;max-height:86vh;overflow:auto;text-align:left';
    const title=document.createElement('div'); title.textContent = `Chest ${id} — Answer to open`; title.style.fontWeight='900'; title.style.marginBottom='8px';
    const qEl = document.createElement('div'); qEl.textContent = question; qEl.style.marginBottom='8px';
    const input = document.createElement('input'); input.type='text'; input.style.width='100%'; input.style.padding='8px'; input.style.borderRadius='8px'; input.value='';
    const hint = document.createElement('div'); hint.className='small-muted'; hint.textContent='Answer comparison is case-insensitive and whitespace-trimmed.'; hint.style.marginTop='6px';
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='12px';
    const btnOk = document.createElement('button'); btnOk.textContent='Submit';
    const btnClose = document.createElement('button'); btnClose.textContent='Cancel';

    function cleanup(){ try{ input.removeEventListener('keydown', onKeyDown); }catch(_){} }
    btnOk.onclick = ()=>{ const val = (input.value||'').trim(); const ans = (answer||'').trim(); if(ans === ''){ if(val.length===0){ toast('Please type an answer'); return; } cleanup(); overlay.remove(); cb(true); return; } if(val.toLowerCase() === ans.toLowerCase()){ cleanup(); overlay.remove(); cb(true); } else { cleanup(); overlay.remove(); cb(false); } };
    btnClose.onclick = ()=>{ cleanup(); overlay.remove(); cb(false); };

    function onKeyDown(ev){ if(ev.key === 'Enter'){ ev.preventDefault(); btnOk.click(); } }
    input.addEventListener('keydown', onKeyDown);

    row.appendChild(btnOk); row.appendChild(btnClose);
    box.appendChild(title); box.appendChild(qEl); box.appendChild(input); box.appendChild(hint); box.appendChild(row);
    overlay.appendChild(box); document.body.appendChild(overlay);
    input.focus();
  }

  function showDialog(text, opts={tts:false, speed:32}){ dialogBox.style.display='block'; dialogBox.textContent=''; let i=0; const iv=setInterval(()=>{ dialogBox.textContent += text[i++]||''; if(i>text.length){ clearInterval(iv); setTimeout(()=> dialogBox.style.display='none',900); } }, 1000/opts.speed); }

  // TREASURE-MAP STYLE LETTER POPUP
  function showLetter(id, text){
    const overlay = document.createElement('div');
    overlay.className = 'letter-overlay';

    const box = document.createElement('div');
    box.className = 'letter-box';

    const title = document.createElement('div');
    title.className = 'letter-title';
    const mainTitle = document.createElement('span');
    mainTitle.textContent = 'SECRET CHEST LETTER';
    const chip = document.createElement('span');
    chip.className = 'chest-chip';
    chip.textContent = `Chest ${id}`;
    title.appendChild(mainTitle);
    title.appendChild(chip);

    // subtitle (fixed - was missing in original and caused errors)
    const subtitle = document.createElement('div');
    subtitle.className = 'letter-sub';
    subtitle.textContent = 'A small note from the maker.';

    const scroll = document.createElement('div');
    scroll.className = 'letter-scroll';

    const quickEdit = document.createElement('textarea');
    quickEdit.className = 'letter-textarea';
    quickEdit.rows = Math.min(16, Math.max(8, Math.ceil((text||'').length/140)));
    quickEdit.placeholder = 'Your letter for this chest will appear here...';
    quickEdit.value = text || '';

    scroll.appendChild(quickEdit);

    const actions = document.createElement('div');
    actions.className = 'letter-actions';
    const btnSave = document.createElement('button'); btnSave.textContent = isAdmin ? 'Save letter & close' : 'Close';
    const btnClose = document.createElement('button'); btnClose.textContent = 'Back to the world';

    actions.appendChild(btnSave);
    actions.appendChild(btnClose);

    const adminNote = document.createElement('div');
    adminNote.className = 'letter-admin-note';
    adminNote.textContent = isAdmin ? 'Admin: edits here will overwrite the saved letter for this chest.' : '';

    function cleanup(){
      try{ quickEdit.removeEventListener('keydown', onQuickKey); } catch(_) {}
      try{ btnSave.removeEventListener('click', onSave); } catch(_) {}
      try{ btnClose.removeEventListener('click', onClose); } catch(_) {}
    }

    function closeAndMaybeFireworks(){
      cleanup();
      overlay.remove();
      if(foundCount === 20){
        // show fireworks if last
        triggerFireworks(5000);
      }
    }

    function onSave(){
      if(!isAdmin){
        // non-admin: treat main button as just close
        closeAndMaybeFireworks();
        return;
      }
      letters[id-1] = quickEdit.value;
      saveState();
      refreshUI();
      closeAndMaybeFireworks();
    }

    function onClose(){
      closeAndMaybeFireworks();
    }

    function onQuickKey(e){
      if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        onSave();
      }
    }

    btnSave.addEventListener('click', onSave);
    btnClose.addEventListener('click', onClose);
    quickEdit.addEventListener('keydown', onQuickKey);

    box.appendChild(title);
    box.appendChild(subtitle);
    box.appendChild(scroll);
    box.appendChild(actions);
    box.appendChild(adminNote);

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    quickEdit.focus();
    quickEdit.setSelectionRange(quickEdit.value.length, quickEdit.value.length);
  }

  // GLTF loader + draco (unchanged)
  const gltfLoader = new GLTFLoader();
  const dracoLoader = new DRACOLoader();
  dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
  gltfLoader.setDRACOLoader(dracoLoader);

  let mixer = null, currentModel = null, actions = {}, activeAction = null;
  const defaultCandidates = [
    'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/WalkingLady/glTF-Binary/WalkingLady.glb',
    'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb'
  ];

  async function loadModelFromUrl(url){
    slog('Loading model: ' + url);
    return new Promise((resolve,reject)=>{
      gltfLoader.load(url, (g)=>resolve(g), (xhr)=>{ if(xhr && xhr.total) slog(`Model ${(xhr.loaded/xhr.total*100).toFixed(0)}%`); }, (err)=>reject(err));
    });
  }

  async function tryLoadDefaultModelSequence(){
    for(const u of defaultCandidates){ try{ const g = await loadModelFromUrl(u); setupModel(g); return; }catch(e){ slog('Candidate failed: ' + u); } }
    slog('No model loaded; staying with placeholder.');
  }

  function setupModel(gltf){
    if(currentModel){ player.remove(currentModel); currentModel.traverse(n=>{ if(n.isMesh) n.geometry?.dispose && n.geometry.dispose(); }); currentModel=null; mixer=null; actions={}; activeAction=null; }
    currentModel = gltf.scene || gltf.scenes[0];
    currentModel.traverse(n=>{ if(n.isMesh){ n.castShadow=true; n.receiveShadow=true; } });
    const bbox = new THREE.Box3().setFromObject(currentModel); const size = new THREE.Vector3(); bbox.getSize(size); const height = size.y||1; const scale = 140/(height||1);
    currentModel.scale.setScalar(scale * 1.25);
    currentModel.position.set(0,0,0);
    if(placeholder && placeholder.parent) player.remove(placeholder);
    player.add(currentModel);
    if(gltf.animations && gltf.animations.length){
      mixer = new THREE.AnimationMixer(currentModel);
      gltf.animations.forEach(clip=>{ actions[clip.name||clip.uuid] = mixer.clipAction(clip); });
      const names = Object.keys(actions);
      const idleName = names.find(n=>/idle/i.test(n))||names[0];
      const walkName = names.find(n=>/walk/i.test(n))||names.find(n=>/run/i.test(n))||names[0];
      for(const n of names){ actions[n].reset().play(); actions[n].enabled=true; actions[n].setEffectiveWeight(0); actions[n].paused=false; }
      activeAction = actions[idleName]; if(activeAction) activeAction.setEffectiveWeight(1);
      player.userData._animIdle = idleName; player.userData._animMove = walkName;
      slog('Animations: ' + names.join(', ') + ' (idle=' + idleName + ' move=' + walkName + ')');
    } else slog('Model has no animations.');
  }

  // --- Replace your initial setPixelRatio + resizeRenderer with this improved version ---
  function resizeRenderer(){
    try{
      // Prefer the #left container if present, otherwise fall back to body
      const left = document.getElementById('left') || document.body;
      const rect = left.getBoundingClientRect();
      // fallback to window inner size if rect is invalid (sometimes happens on load/iframe)
      let w = Math.max(64, Math.floor(rect.width) || window.innerWidth);
      let h = Math.max(64, Math.floor(window.innerHeight));

      // Use actual devicePixelRatio (no aggressive clamping). You can clamp if you want to limit GPU cost.
      const DPR = window.devicePixelRatio || 1;
      // Optionally clamp DPR to avoid super-high render cost on very high DPI displays:
      const maxDPR = 2.5;
      const dpr = Math.min(DPR, maxDPR);

      // Set pixel ratio first, then set size. Use updateStyle = true so three updates canvas style automatically.
      renderer.setPixelRatio(dpr);
      renderer.setSize(w, h, /*updateStyle=*/ true);

      // Ensure camera aspect is correct and projection matrix updated
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }catch(e){
      slog('resizeRenderer error: ' + e);
    }
  }
  window.addEventListener('resize', resizeRenderer, { passive: true });
  resizeRenderer();

  // MAIN LOOP
  let last = performance.now();
  function mainLoop(now){
    try{
      const dt = Math.min(0.05, (now - last)/1000); last = now;

      const camQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(cameraPitch, cameraYaw, 0, 'YXZ'));
      const camForward = new THREE.Vector3(0,0,-1).applyQuaternion(camQuat).setY(0).normalize();
      const camRight = new THREE.Vector3().crossVectors(camForward, new THREE.Vector3(0,1,0)).normalize();

      let moveDir = new THREE.Vector3(0,0,0);
      // ---------- MODIFIED: movement checks only use arrow keys ----------
      if(!cinematicActive){
        if(keys['arrowup']) moveDir.add(camForward);
        if(keys['arrowdown']) moveDir.sub(camForward);
        if(keys['arrowleft']) moveDir.sub(camRight);
        if(keys['arrowright']) moveDir.add(camRight);
      }
      const isMoving = moveDir.lengthSq() > 0;

      if(isMoving){ moveDir.normalize(); player.position.addScaledVector(moveDir, MOVE_SPEED * dt); const targetYaw = Math.atan2(moveDir.x, moveDir.z); const currentYaw = player.rotation.y || 0; let diff = targetYaw - currentYaw; diff = (diff + Math.PI) % (Math.PI*2) - Math.PI; const ROT_SPEED = 12; player.rotation.y = currentYaw + diff * Math.min(1, ROT_SPEED * dt); }

      const downRay = new THREE.Raycaster(new THREE.Vector3(player.position.x, 400, player.position.z), new THREE.Vector3(0,-1,0));
      const hits = downRay.intersectObject(ground);
      let groundY = -Infinity;
      if(hits.length) groundY = hits[0].point.y;
      if(player.position.y <= groundY + 40 + 0.1){ player.position.y = groundY + 40; velocity.y = 0; onGround = true; } else { onGround = false; velocity.y += GRAV * dt; player.position.y += velocity.y * dt; }

      if(placeholder) placeholder.position.y = Math.sin(walkTimer) * (isMoving ? 3 : 1.2);

      if(mixer){ mixer.update(dt); const idleName = player.userData._animIdle; const moveName = player.userData._animMove; if(idleName && moveName && actions[idleName] && actions[moveName]){ const idle = actions[idleName]; const move = actions[moveName]; const targetMoveWeight = isMoving ? 1 : 0; idle.setEffectiveWeight(THREE.MathUtils.lerp(idle.getEffectiveWeight(), 1 - targetMoveWeight, 0.12)); move.setEffectiveWeight(THREE.MathUtils.lerp(move.getEffectiveWeight(), targetMoveWeight, 0.12)); } }

      // particles update
      ensureParticleMeshes(particles.length);
      for(let i=0;i<particlePool.length;i++){ const m = particlePool[i]; if(i < particles.length){ const p = particles[i]; m.visible = true; m.position.copy(p.pos); m.material.color.setHex(p.color); m.scale.setScalar(1 + (1 - Math.max(0, p.life)) * 1.2); } else m.visible = false; }
      for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.life -= dt; p.vel.y -= 600*dt; p.pos.addScaledVector(p.vel, dt); if(p.life <= 0) particles.splice(i,1); }

      ensureHeartMeshes(heartParticles.length);
      for(let i=0;i<heartPool.length;i++){ const m = heartPool[i]; if(i < heartParticles.length){ const p = heartParticles[i]; m.visible = true; m.position.copy(p.pos); const s = p.scale || 1; m.scale.setScalar(s); m.material.opacity = Math.max(0, Math.min(1, p.life/2)); } else m.visible = false; }
      for(let i=heartParticles.length-1;i>=0;i--){ const p = heartParticles[i]; p.life -= dt; p.pos.addScaledVector(p.vel, dt); p.vel.x *= (1 - 0.01); p.vel.z *= (1 - 0.01); if(p.life <= 0) heartParticles.splice(i,1); }

      chests.forEach(c => { if(c.collected) c.group.children[1].rotation.x = THREE.MathUtils.lerp(c.group.children[1].rotation.x, -0.95, 0.12); });

      // cinematic-aware camera follow
      if(cinematicActive){
        const t = (performance.now() - cinematicStart) / cinematicDuration;
        const clamped = Math.min(1, Math.max(0, t));
        const startAngle = cameraYaw || 0;
        const angle = startAngle + (clamped * cinematicRotations * Math.PI * 2);
        const pitch = -0.25 + (0.08 * Math.sin(clamped * Math.PI));
        const radius = cameraDistanceDefault * (1 - 0.06 * Math.sin(clamped * Math.PI));
        const camQuatC = new THREE.Quaternion().setFromEuler(new THREE.Euler(pitch, angle, 0, 'YXZ'));
        tmpVec3.set(0, 220, radius);
        camWorldOffset.copy(tmpVec3).applyQuaternion(camQuatC);
        camera.position.copy(player.position).add(camWorldOffset);
        tmpVec3.set(player.position.x, player.position.y + 20 + (40 * Math.sin(clamped * Math.PI)), player.position.z);
        camera.lookAt(tmpVec3);
        if(clamped >= 1){
          cinematicActive = false;
          showEndingMessage();
        }
      } else {
        tmpVec3.set(0, 220, cameraDistanceDefault);
        camWorldOffset.copy(tmpVec3).applyQuaternion(camQuat);
        desiredCamPos.copy(player.position).add(camWorldOffset);
        camera.position.lerp(desiredCamPos, CAMERA_POS_LERP);
        tmpVec3.set(player.position.x, player.position.y + 20, player.position.z);
        cameraTarget.lerp(tmpVec3, CAMERA_TARGET_LERP);
        camera.lookAt(cameraTarget);
      }

      renderer.render(scene, camera);
      if(isMoving) walkTimer += dt * 8; else walkTimer += dt * 1;
    }catch(err){ slog('mainLoop error: ' + (err && err.stack ? err.stack : err)); }
    requestAnimationFrame(mainLoop);
  }
  requestAnimationFrame(mainLoop);

  // tooltip updater + chest-popup
  function updateTooltip(){ try{ let near=null, nd=Infinity; for(const c of chests){ if(c.collected) continue; const d=Math.hypot(player.position.x - c.x, player.position.z - c.z); if(d < nd && d < 300){ nd=d; near=c; } } if(near){ tooltipEl.style.display='block'; tooltipEl.textContent = `Chest ${near.id} ${near.id===nextChest? '— Press Tab to open' : '— Locked'}`;
      const v=new THREE.Vector3(near.x,30,near.z); v.project(camera);
      const rect=renderer.domElement.getBoundingClientRect();
      const left = rect.left + (v.x*0.5+0.5)*rect.width;
      const top = rect.top + (-v.y*0.5+0.5)*rect.height;
      tooltipEl.style.left = `${left}px`;
      tooltipEl.style.top = `${top}px`;
      if(nextPill) nextPill.style.display = 'none';

      if(chestPopup){
        chestPopup.style.display = 'block';
        chestPopup.querySelector('.num').textContent = String(near.id);
        const worldAbove = new THREE.Vector3(near.x, 48, near.z);
        const proj = worldAbove.project(camera);
        const px = rect.left + (proj.x*0.5+0.5)*rect.width;
        const py = rect.top + (-proj.y*0.5+0.5)*rect.height;
        chestPopup.style.left = px + 'px';
        chestPopup.style.top = py + 'px';
        chestPopup.style.transform = 'translate(-50%,-120%) scale(1.0)';
      }
    } else {
      tooltipEl.style.display='none';
      if(nextPill) nextPill.style.display = 'inline-block';
      if(chestPopup) chestPopup.style.display = 'none';
    } }catch(e){} requestAnimationFrame(updateTooltip); }
  updateTooltip();

  renderer.domElement.addEventListener('click', e=>{
    const rect = renderer.domElement.getBoundingClientRect();
    const sx = (e.clientX - rect.left) / rect.width * 2 - 1;
    const sy = -((e.clientY - rect.top) / rect.height) * 2 + 1;
    const ray = new THREE.Raycaster();
    ray.setFromCamera(new THREE.Vector2(sx, sy), camera);
    const hits = ray.intersectObject(ground);
    if(hits.length){
      const p = hits[0].point;
      if(e.ctrlKey) player.position.set(p.x, p.y + 40, p.z);
    }
  });

  // init
  createChestTextareas();
  const loaded = loadState();
  refreshUI();
  tryLoadDefaultModelSequence();
  slog('Per-chest letters + Q/A build loaded. Admin=' + (isAdmin ? 'yes' : 'no') + '.');

  // -------------------------
  // Birthday popup logic
  // -------------------------
  (function setupBirthdayPopup(){
    const popup = document.getElementById('birthdayPopup');
    const closeBtn = document.getElementById('birthdayClose');
    function closePopup(){ if(!popup) return; popup.style.display = 'none'; popup.setAttribute('aria-hidden', 'true'); }
    closeBtn.addEventListener('click', closePopup);
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closePopup(); });
    setTimeout(()=>{ if(popup) { popup.style.display = 'flex'; popup.setAttribute('aria-hidden','false'); } }, 120);
  })();

  // final admin UI toggle
  (function applyAdminUI(){
    const side = document.getElementById('side');
    if(isAdmin){
      adminBadge.style.display='inline-block';
      readOnlyNote.style.display='none';
      saveBtn.style.display='inline-block';
      if(side) side.style.display = 'block';
      // hide the user reset button for admins (admins already have full controls)
      if(resetUserBtn) resetUserBtn.style.display = 'none';
    } else {
      adminBadge.style.display='none';
      readOnlyNote.style.display='block';
      saveBtn.style.display='none';
      // hide entire sidebar for non-admins
      if(side) side.style.display = 'none';
      // non-admins keep the floating reset button visible (already in HUD)
      if(resetUserBtn) resetUserBtn.style.display = 'inline-block';
    }
  })();

  </script>
</body>
</html>

